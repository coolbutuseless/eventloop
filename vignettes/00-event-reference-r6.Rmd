---
title: "Event Reference Example - R6"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Event Reference Example - R6}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Event Reference Example - R6

The following example just prints information to the console about the 
events that are happening in the window.

Instead of using global variables to store state information
(as in all the other vignettes),  variables to be retained are stored 
as members of an R6 object's environment.

This could be a good place to start if developing code from scratch.

```{r setup, eval = FALSE}
library(R6)
library(eventloop)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#' This is a verbose callback that simply prints information to the console
#' about what events are happening
#' 
#' Rather than keeping the state in a global variable, variables are 
#' stored in the R6 object environment.
#' 
#' Press ESC to quit.
#' 
#' @param event The event from the graphics device. Is NULL when no event
#'        occurred.  Otherwise has `type` element set to:
#'        `event$type = 'mouse_down'` 
#'               - an event in which a mouse button was pressed
#'               - `event$button` gives the index of the button
#'        `event$type = 'mouse_up'`   
#'               - a mouse button was released
#'        `event$type = 'key_press'`  
#'               - a key was pressed
#'               - `event$char` holds the character as string
#'               - `event$int` holds the integer representation
#' @param mouse_x,mouse_y current location of mouse within window. If mouse is 
#'        not within window, this will be set to the last available coordinates
#' @param frame_num integer count of which frame this is
#' @param fps_actual,fps_target the curent framerate and the framerate specified
#'        by the user
#' @param dev_width,dev_height the width and height of the output device. Note:
#'        this does not cope well if you resize the window
#' @param ... any extra arguments ignored
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Agent <- R6::R6Class(
  "Agent",
  
  public = list(
    
    last_x = NULL,
    last_y = NULL,
    
    initialize = function() {
      self$last_x <- NA
      self$last_y <- NA
      invisible(self)
    },
    
    update = function(event, mouse_x, mouse_y, frame_num, fps_actual,
                      fps_target, dev_width, dev_height, ...) {
      
      # Did an event happen at all in this window?
      if (!is.null(event)) {
        
        # Draw a line
        if (!is.na(self$last_x)) {
          grid::grid.lines(
            x = c(self$last_x, mouse_x),
            y = c(self$last_y, mouse_y)
          )
        }
        
        # Keep track of latest mouse position
        self$last_x <- mouse_x
        self$last_y <- mouse_y
        
        # "Handle" the event by printing to console
        co <- sprintf("[%.2f, %.2f]", mouse_x, mouse_y)
        if (event$type %in% c('mouse_down', 'mouse_up')) {
          cat(co, "Mouse: ", event$type, " - button: ", event$button, "\n")
        } else if (event$type == 'mouse_move') {
          cat(co, "Move \n")
        } else if (event$type == 'key_press') {
          cat(co, "Key: ", event$char, " - integer value [", event$int, "]\n")
        }
      }
    }
  )
)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Create the 'Agent' object and run the loop
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
agent <- Agent$new()
eventloop::run_loop(agent$update, fps_target = 10, show_fps = TRUE)
```
