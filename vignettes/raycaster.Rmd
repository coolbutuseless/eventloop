---
title: "raycaster"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{raycaster}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r}
N <- 9
mat <- matrix(seq(N*N), N, N)
```


```{r setup}
library(eventloop)
library(ggplot2)
library(dplyr)
library(purrr)
library(grid)
library(magrittr)

N <- 9
set.seed(1)
mat <- matrix(sample(c(0, 1), N*N, replace = TRUE, prob = c(0.85, 0.3)), N, N)
mat[1,] <- 1
mat[N,] <- 1
mat[,1] <- 1
mat[,N] <- 1
# mat <- matrix(seq(N*N), N, N)

df <- expand.grid(y = seq(N)-0.5, x = seq(N)-0.5)
df$val <- as.vector(mat)
df$col <- ifelse(df$val == 1, 'grey70', 'white')

angle_start = 150
start1 <- Sys.time()
for (angle_start in 0:359) {

angle_deg <- angle_start + seq(0, 30, length.out = 30)
Nangs <- length(angle_deg)

  
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
x0 <- 4.7
y0 <- 3.4

start_inner <- Sys.time() 

theta_orig <- theta <- angle_deg * pi/180
theta <- rep(theta, each = N)

quadrant <- as.integer( (angle_deg %% 360) / 90) + 1L
quadrant <- rep(quadrant, each=N)

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
yfrac <- 1 - (y0 - floor(y0))
yfrac <- rep(yfrac, N)

dx <- 1/tan(theta)
dx <- rep(dx, N)

dy    <- ifelse(quadrant %in% 1:2,     1,        -1)
yfrac <- ifelse(quadrant %in% 1:2, yfrac, 1 - yfrac)
dx    <- ifelse(quadrant %in% 1:2,    dx,       -dx)


mults <- yfrac + rep(seq.int(0, N-1L), times = Nangs)
horx = x0 + mults * dx
hory = y0 + mults * dy

idx <- horx > 0 & horx < N & hory > 0 & hory < N
horx[!idx] <- NA_real_
hory[!idx] <- NA_real_


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
xfrac <- 1 - (x0 - floor(x0))
xfrac <- rep(xfrac, N)

dy <-   tan(theta)
dy <- rep(dy, N)

dx    <- ifelse(quadrant %in% c(1L, 4L),     1,        -1)
xfrac <- ifelse(quadrant %in% c(1L, 4L), xfrac, 1 - xfrac)
dy    <- ifelse(quadrant %in% c(1L, 4L),    dy,       -dy)

mults <- xfrac + rep(seq.int(0, N-1L), times = Nangs)
verx = x0 + mults * dx
very = y0 + mults * dy


idx <- verx > 0 & verx < N & very > 0 & very < N
verx[!idx] <- NA_real_
very[!idx] <- NA_real_

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
hhits_y <- ifelse(quadrant %in% 1:2, hory + 1, hory)
hhits_x <- ceiling(horx)
vhits_y <- ceiling(very)
vhits_x <- ifelse(quadrant %in% c(1L, 4L), verx + 1, verx)

hhits <- mat[cbind(hhits_y, hhits_x)]
vhits <- mat[cbind(vhits_y, vhits_x)]

hray <- rep(seq(Nangs), each = N)
vray <- rep(seq(Nangs), each = N)

htype <- rep(1L, length(hory))
vtype <- rep(2L, length(very))

hidx <- which(hhits == 1)
vidx <- which(vhits == 1)


fhorx <- horx[hidx]
fhory <- hory[hidx]
fhray <- hray[hidx]

fverx <- verx[vidx]
fvery <- very[vidx]
fvray <- vray[vidx]


x   <- c(fhorx, fverx)
y   <- c(fhory, fvery)
ray <- c(fhray, fvray)
type <- c(htype[hidx], vtype[vidx])


raw_dists <- sqrt( (x - x0)^2 + (y - y0)^2 )
dists <- aggregate(raw_dists, by = list(ray = ray), min)

sray <- sort(ray)
types <- type[order(ray, raw_dists)]
types <- aggregate(types, list(ray = sray), head, 1)

print(Sys.time() - start_inner)

xh <- x0 + dists$x * cos(theta_orig)
yh <- y0 + dists$x * sin(theta_orig)


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Plot the DDA view
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
dunit <- 'cm'

filename <- sprintf("working/raycast/%03i.png", angle_start)
png(filename, width=700, height= 700)

grid.rect(gp = gpar(fill='lightblue'))
grid.rect(y = 0.25, height = 0.5, gp = gpar(fill = 'grey70'))

dists2 <- dists$x * cos(seq(-Nangs/2, Nangs/2, length.out = Nangs) * pi/180)

fill <- c('darkblue', 'blue')[types$x]

grid.rect(x = ((Nangs:1)/Nangs), width = 1/Nangs, height = (N - dists2)/15, gp = gpar(col=NA, fill=fill))


grid.rect(x = df$x, y = df$y, width = 1, height = 1, default.units = dunit,
          gp = gpar(fill = df$col, col = 'grey50'))
# grid.text(df$val,df$x, df$y, default.units = dunit, gp = gpar(col = 'grey40'))
grid.points(x0, y0, default.units = dunit)


d <- 5
x1 <- x0 + d * cos(theta_orig)
y1 <- y0 + d * sin(theta_orig)
grid.polyline(c(rbind(x0, x1)), c(rbind(y0, y1)), default.units = dunit,
           gp = gpar(lty = 2, col = '#80808070'), id = rep(seq(Nangs), each = 2))

# if (length(horx) > 0) {
# grid.points(horx, hory, default.units = dunit,
#             gp = gpar(col = 'blue'))
# }
# 
# if (length(verx) > 0) {
#   grid.points(verx, very, default.units = dunit,
#             gp = gpar(col = 'red'))
# }

grid.polyline(c(rbind(x0, xh)), c(rbind(y0, yh)), default.units = dunit,
           gp = gpar(col = 'darkgreen', lwd = 4), id = rep(seq(Nangs), each = 2))

dev.off()

}
print(Sys.time() - start1)
```






